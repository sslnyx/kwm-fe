---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Register - Kentwood Homes">
    <main class="pt-20">
        <section class="py-16 bg-white min-h-screen">
            <div class="container max-w-2xl">
                <!-- Header -->
                <div class="mb-10 data-aos="fade-up"">
                    <h1
                        class="text-4xl md:text-5xl font-bold text-primary italic mb-4"
                    >
                        Register
                    </h1>
                    <p class="text-secondary/70 text-lg">
                        Stay in the loop on new builds, upcoming projects and
                        fresh opportunities to make one yours.
                    </p>
                </div>

                <form class="space-y-8">
                    <!-- Name Fields -->
                    <div class="grid md:grid-cols-2 gap-6 data-aos="fade-up"">
                        <div>
                            <input
                                type="text"
                                id="firstName"
                                name="firstName"
                                placeholder="First Name"
                                class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all"
                                required
                            />
                        </div>
                        <div>
                            <input
                                type="text"
                                id="lastName"
                                name="lastName"
                                placeholder="Last Name"
                                class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all"
                                required
                            />
                        </div>
                    </div>

                    <!-- Contact Fields -->
                    <div class="grid md:grid-cols-2 gap-6 data-aos="fade-up"">
                        <div>
                            <input
                                type="email"
                                id="email"
                                name="email"
                                placeholder="Email"
                                class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all"
                                required
                            />
                        </div>
                        <div>
                            <input
                                type="tel"
                                id="phone"
                                name="phone"
                                placeholder="Phone"
                                class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all"
                            />
                        </div>
                    </div>

                    <!-- Project Interest -->
                    <div class="space-y-4 data-aos="fade-up"">
                        <p class="font-bold text-secondary">
                            Which project are you interested in:
                        </p>
                        <div class="flex flex-wrap gap-8">
                            <label
                                class="flex items-center gap-3 cursor-pointer"
                            >
                                <input
                                    type="checkbox"
                                    name="projects"
                                    value="mcgill"
                                    class="w-5 h-5 border-2 border-gray-300 rounded accent-primary"
                                />
                                <span class="text-primary font-semibold"
                                    >Mc<span class="text-secondary">Gill</span
                                    ></span
                                >
                            </label>
                            <label
                                class="flex items-center gap-3 cursor-pointer"
                            >
                                <input
                                    type="checkbox"
                                    name="projects"
                                    value="skeena"
                                    class="w-5 h-5 border-2 border-gray-300 rounded accent-primary"
                                />
                                <span class="text-primary font-semibold"
                                    >Skeena</span
                                >
                            </label>
                            <label
                                class="flex items-center gap-3 cursor-pointer"
                            >
                                <input
                                    type="checkbox"
                                    name="projects"
                                    value="oakridge"
                                    class="w-5 h-5 border-2 border-gray-300 rounded accent-primary"
                                />
                                <span class="text-primary font-semibold"
                                    >Oak<span class="text-secondary">Ridge</span
                                    ></span
                                >
                            </label>
                        </div>
                    </div>

                    <!-- Role -->
                    <div class="space-y-4 data-aos="fade-up"">
                        <p class="font-bold text-secondary">Are you a:</p>
                        <div class="flex flex-wrap gap-8">
                            <label
                                class="flex items-center gap-3 cursor-pointer"
                            >
                                <input
                                    type="checkbox"
                                    name="roles"
                                    value="realtor"
                                    class="w-5 h-5 border-2 border-gray-300 rounded accent-primary"
                                />
                                <span class="text-secondary">Realtor</span>
                            </label>
                            <label
                                class="flex items-center gap-3 cursor-pointer"
                            >
                                <input
                                    type="checkbox"
                                    name="roles"
                                    value="investor"
                                    class="w-5 h-5 border-2 border-gray-300 rounded accent-primary"
                                />
                                <span class="text-secondary">Investor</span>
                            </label>
                            <label
                                class="flex items-center gap-3 cursor-pointer"
                            >
                                <input
                                    type="checkbox"
                                    name="roles"
                                    value="homeowner"
                                    class="w-5 h-5 border-2 border-gray-300 rounded accent-primary"
                                />
                                <span class="text-secondary">Homeowner</span>
                            </label>
                            <label
                                class="flex items-center gap-3 cursor-pointer"
                            >
                                <input
                                    type="checkbox"
                                    name="roles"
                                    value="buyer"
                                    class="w-5 h-5 border-2 border-gray-300 rounded accent-primary"
                                />
                                <span class="text-secondary">Buyer</span>
                            </label>
                        </div>
                    </div>

                    <!-- Source -->
                    <div class="space-y-4 data-aos="fade-up"">
                        <p class="font-bold text-secondary">
                            How did you hear from us:
                        </p>
                        <div class="flex flex-wrap gap-8">
                            <label
                                class="flex items-center gap-3 cursor-pointer"
                            >
                                <input
                                    type="checkbox"
                                    name="source"
                                    value="referral"
                                    class="w-5 h-5 border-2 border-gray-300 rounded accent-primary"
                                />
                                <span class="text-secondary">Referral</span>
                            </label>
                            <label
                                class="flex items-center gap-3 cursor-pointer"
                            >
                                <input
                                    type="checkbox"
                                    name="source"
                                    value="signage"
                                    class="w-5 h-5 border-2 border-gray-300 rounded accent-primary"
                                />
                                <span class="text-secondary">Signage</span>
                            </label>
                            <label
                                class="flex items-center gap-3 cursor-pointer"
                            >
                                <input
                                    type="checkbox"
                                    name="source"
                                    value="instagram"
                                    class="w-5 h-5 border-2 border-gray-300 rounded accent-primary"
                                />
                                <span class="text-secondary">Instagram</span>
                            </label>
                            <label
                                class="flex items-center gap-3 cursor-pointer"
                            >
                                <input
                                    type="checkbox"
                                    name="source"
                                    value="facebook"
                                    class="w-5 h-5 border-2 border-gray-300 rounded accent-primary"
                                />
                                <span class="text-secondary">Facebook</span>
                            </label>
                        </div>
                    </div>

                    <!-- Comments -->
                    <div>
                        <textarea
                            id="comments"
                            name="comments"
                            rows="5"
                            placeholder="Comments:"
                            class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all resize-none"
                        ></textarea>
                    </div>

                    <!-- Consent -->
                    <div class="flex items-start gap-3">
                        <input
                            type="checkbox"
                            id="consent"
                            name="consent"
                            required
                            class="w-5 h-5 mt-0.5 border-2 border-gray-300 rounded accent-primary flex-shrink-0"
                        />
                        <label
                            for="consent"
                            class="text-sm text-secondary/70 leading-relaxed"
                        >
                            I agree to allow Kentwood Homes and its affiliates
                            to contact me via phone and email. I understand I
                            can unsubscribe at any time.*
                        </label>
                    </div>

                    <!-- Submit Button -->
                    <div class="text-center pt-4">
                        <button
                            type="submit"
                            class="bg-gradient-to-b from-primary to-primary/80 text-white font-bold uppercase px-16 py-4 rounded-full hover:shadow-lg hover:scale-[1.02] transition-all shadow-md text-lg tracking-wide"
                        >
                            Submit
                        </button>
                    </div>
                </form>
            </div>
        </section>
    </main>
</Layout>

<style>
    /* Custom checkbox styling */
    input[type="checkbox"] {
        appearance: none;
        -webkit-appearance: none;
        width: 1.25rem;
        height: 1.25rem;
        border: 2px solid #d1d5db;
        border-radius: 0.25rem;
        background: white;
        cursor: pointer;
        position: relative;
    }

    input[type="checkbox"]:checked {
        background-color: #88b04b;
        border-color: #88b04b;
    }

    input[type="checkbox"]:checked::after {
        content: "✓";
        position: absolute;
        color: white;
        font-size: 0.875rem;
        font-weight: bold;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }
</style>

<script>
    const API_BASE_URL =
        import.meta.env.PUBLIC_API_URL || "https://kmw-app.irix.design/api";

    const form = document.querySelector("form") as HTMLFormElement | null;
    if (form) {
        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const submitBtn = form.querySelector(
                'button[type="submit"]',
            ) as HTMLButtonElement | null;
            if (!submitBtn) return;

            const originalText = submitBtn.textContent;
            submitBtn.textContent = "Submitting...";
            submitBtn.disabled = true;

            // Collect checkbox values as arrays
            const getCheckedValues = (name: string): string[] => {
                const checkboxes = form.querySelectorAll(
                    `input[name="${name}"]:checked`,
                ) as NodeListOf<HTMLInputElement>;
                return Array.from(checkboxes).map((cb) => cb.value);
            };

            const data = {
                firstName:
                    (form.querySelector("#firstName") as HTMLInputElement)
                        ?.value || "",
                lastName:
                    (form.querySelector("#lastName") as HTMLInputElement)
                        ?.value || "",
                email:
                    (form.querySelector("#email") as HTMLInputElement)?.value ||
                    "",
                phone:
                    (form.querySelector("#phone") as HTMLInputElement)?.value ||
                    "",
                projects: getCheckedValues("projects"),
                roles: getCheckedValues("roles"),
                source: getCheckedValues("source"),
                comments:
                    (form.querySelector("#comments") as HTMLTextAreaElement)
                        ?.value || "",
                consent:
                    (form.querySelector("#consent") as HTMLInputElement)
                        ?.checked || false,
            };

            try {
                const response = await fetch(`${API_BASE_URL}/register`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Accept: "application/json",
                    },
                    body: JSON.stringify(data),
                });

                const result = await response.json();

                if (result.success) {
                    // Show success message
                    const container = form.closest(".container");
                    if (container) {
                        container.innerHTML = `
                            <div class="text-center py-16">
                                <div class="text-6xl mb-6 text-primary">✓</div>
                                <h2 class="text-3xl font-bold text-primary italic mb-4">Thank You!</h2>
                                <p class="text-secondary/70 text-lg max-w-md mx-auto">${result.message}</p>
                                <a href="/" class="inline-block mt-8 bg-primary text-white font-bold px-8 py-3 rounded-full hover:bg-primary/90 transition-all">
                                    Back to Home
                                </a>
                            </div>
                        `;
                    }
                } else {
                    // Show validation errors
                    const errors = Object.values(result.errors || {})
                        .flat()
                        .join("\n");
                    alert("Please fix the following errors:\n" + errors);
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            } catch (error) {
                console.error("Form submission error:", error);
                alert("Something went wrong. Please try again later.");
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });
    }
</script>
